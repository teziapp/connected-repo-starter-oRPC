# Backend Agent Guidelines

## Commands
- **Dev**: `yarn dev` (watch mode), `yarn dev:inspect` (with debugger)
- **Build**: `yarn build` (TypeScript compilation)
- **Database**: `yarn db g <name>` (generate migration), `yarn db up` (apply), `yarn db seed` (seed data)
- **Test DB**: `yarn test:db:setup` (drop, create, migrate, seed test database)
- **Tests**: `yarn test` (unit tests), `yarn test:ui` (UI mode), `yarn test:coverage` (coverage report)

## Tech Stack
- **Runtime**: Node.js 22+
- **Framework**: Fastify (no framework-specific code, uses oRPC handlers)
- **API**: oRPC for type-safe endpoints
- **Database**: PostgreSQL + Orchid ORM
- **Auth**: Better Auth with Google OAuth (orchid-adapter for transactions)
- **Testing**: Vitest with test database isolation
- **Validation**: Zod schemas from `@connected-repo/zod-schemas`
- **Observability**: OpenTelemetry integration, Sentry error tracking

## Project Structure

```
apps/backend/src/
├── modules/              # Feature modules (tables, business logic, tests)
│   ├── auth/            # Authentication & session management
│   ├── journal-entries/ # Journal entries with CRUD + tests
│   ├── prompts/         # Prompt management
│   ├── teams/           # Team & member management
│   └── users/           # User management
├── routers/
│   └── user_app/        # User-facing oRPC routes
├── request_handlers/    # Request handling (Better Auth, oRPC)
├── procedures/          # oRPC procedures (public, protected, sensitive)
├── middlewares/         # API key auth, IP whitelist, session security
├── db/                  # Database setup, migrations, seeds
├── test/                # Test utilities (auth helpers, setup)
├── configs/             # Environment config, allowed origins
├── sentry.sdk.ts        # Sentry SDK configuration
└── server.ts            # Entry point
```

## Architecture Patterns

### Database Tables (Orchid ORM)

**1. Create Table Definition**
Location: `apps/backend/src/modules/<module>/tables/<entity>.table.ts`

```typescript
import { BaseTable } from '../../../db/base_table';

export class JournalEntriesTable extends BaseTable {
  readonly table = 'journal_entries';
  columns = this.setColumns((t) => ({
    journalEntryId: t.uuid().primaryKey().default(t.sql`gen_random_uuid()`),
    authorUserId: t.uuid().foreignKey('users', 'userId'),
    content: t.text(),
    ...this.baseTableColumns(t),  // createdAt, updatedAt
  }));
}
```

**Key Rules:**
- Descriptive IDs: `userId`, `journalEntryId` (not generic `id`)
- Descriptive FKs: `authorUserId` (not just `authorId`)
- Use `timestampNumber` for timestamps (epoch milliseconds)
- snake_case for columns, PascalCase for class names

**2. Create Zod Schemas**
Location: `packages/zod-schemas/src/<entity>.zod.ts`

```typescript
import z from 'zod';
import { zString, zTimestamps } from './zod_utils.js';

// Required fields
export const journalEntryMandatoryZod = z.object({
  content: zString.min(1),
});

// Optional/nullable fields
export const journalEntryOptionalZod = z.object({
  mood: zString.nullable(),
});

// Auto-generated (IDs, timestamps)
const journalEntryAutoGeneratedZod = z.object({
  journalEntryId: z.string().uuid(),
  authorUserId: z.string().uuid(),
});

// Operation schemas
export const journalEntryCreateInputZod = journalEntryMandatoryZod.extend(
  journalEntryOptionalZod.partial().shape
);

export const journalEntryUpdateInputZod = journalEntryMandatoryZod
  .extend(journalEntryOptionalZod.shape)
  .extend(zTimestamps)
  .partial();

export const journalEntrySelectAllZod = journalEntryMandatoryZod
  .extend(journalEntryOptionalZod.shape)
  .extend(zTimestamps)
  .extend(journalEntryAutoGeneratedZod.shape);

// Query schemas
export const journalEntryGetByIdInputZod = z.object({
  journalEntryId: z.string().uuid(),
});
```

**3. Register Table**
Add to `apps/backend/src/db/db.ts`:

```typescript
import { JournalEntriesTable } from '../modules/journal-entries/tables/journal_entries.table';

export const db = orchidORM(
  { databaseURL: envConfig.DATABASE_URL },
  {
    journalEntries: JournalEntriesTable,
    // ... other tables
  }
);
```

**4. Generate Migration**
Always use commands to generate migrations. Never generate them manually.
```bash
yarn db g create_journal_entries_table
yarn db up
```

**5. Create Fixtures (for testing)**
Location: `packages/zod-schemas/src/<entity>.fixture.ts`

```typescript
import type { z } from 'zod';
import type { journalEntryCreateInputZod } from './journal_entry.zod';

export const journalEntryFixture: z.infer<typeof journalEntryCreateInputZod> = {
  content: 'Test journal entry content',
  mood: 'happy',
};
```

### oRPC Endpoints

**1. Create Procedure**
Location: `apps/backend/src/modules/<module>/<module>.router.ts`

```typescript
import { rpcProtectedProcedure } from '../../procedures/protected.procedure';
import { journalEntryCreateInputZod } from '@connected-repo/zod-schemas/journal_entry.zod';
import { db } from '../../db/db';

export const createJournalEntry = rpcProtectedProcedure
  .input(journalEntryCreateInputZod)
  .handler(async ({ input, context }) => {
    const { user } = context;
    
    const entry = await db.journalEntries.create({
      ...input,
      authorUserId: user.id,
    });
    
    return entry;
  });
```

**Procedure Types:**
- `rpcPublicProcedure`: No authentication required
- `rpcProtectedProcedure`: Requires authenticated user (validates `session.id` and `user.id`)
- `rpcSensitiveProcedure`: Additional security checks

**2. Register in Router**
Add to `apps/backend/src/routers/user_app/user_app.router.ts`:

```typescript
import { createJournalEntry } from '../../modules/journal-entries/journal-entries.router';

export const userAppRouter = {
  journalEntry: {
    create: createJournalEntry,
    getAll: getAllJournalEntries,
    // ... other endpoints
  },
};
```

**3. Frontend Auto-Gets Types**
No codegen needed - frontend imports type and uses:

```typescript
// Frontend automatically infers types
const { data } = orpc.journalEntry.create.useMutation();
```

### Testing (Vitest)

**Setup Test Database**
```bash
yarn test:db:setup  # Drops, creates, migrates, seeds test DB
```

**Test Structure**
Location: `apps/backend/src/modules/<module>/<module>.test.ts`

```typescript
import { beforeAll, describe, expect, test } from 'vitest';
import { db } from '../../db/db';
import { createTestUserAndSession } from '../../test/utils/user-auth.utils';

describe('Journal Entries', () => {
  let userId: string;
  let sessionToken: string;

  beforeAll(async () => {
    const result = await createTestUserAndSession(db);
    userId = result.userId;
    sessionToken = result.sessionToken;
  });

  test('create journal entry', async () => {
    const entry = await db.journalEntries.create({
      content: 'Test entry',
      authorUserId: userId,
    });

    expect(entry.journalEntryId).toBeDefined();
    expect(entry.content).toBe('Test entry');
  });
});
```

**Test Utilities**
- `createTestUserAndSession(db)`: Creates user + session, returns `{ userId, sessionToken }`
- Located in `apps/backend/src/test/utils/user-auth.utils.ts`
- Test setup in `apps/backend/src/test/setup.ts`

**Running Tests**
```bash
yarn test              # Run all tests
yarn test:ui           # UI mode
yarn test:coverage     # Coverage report
NODE_ENV=test          # Automatically set by test scripts
```

### Authentication & Authorization

**Better Auth Integration**
- Google OAuth configured in `apps/backend/src/modules/auth/auth.config.ts`
- Custom Orchid adapter for transaction support
- Session stored in database (`sessions` table)

**Auth Middleware**
Location: `apps/backend/src/modules/auth/auth.middleware.ts`

Validates:
1. Session exists and is valid (`session.id` present)
2. User exists and matches session (`user.id` present)
3. Session not expired

**Session Security Middleware**
Location: `apps/backend/src/middlewares/session-security.middleware.ts`

Tracks device fingerprints and detects suspicious activity.

**API Key Auth (for external APIs)**
Location: `apps/backend/src/middlewares/api-key-auth.middleware.ts`

Validates team API keys using scrypt hashing.

### Error Handling

**Centralized Error Parsing**
Location: `apps/backend/src/utils/errorParser.ts`

Converts errors to user-friendly messages:
- Database constraint violations
- Validation errors
- Generic error fallback

**Usage:**
```typescript
import { handleErrors } from '../../utils/errorParser';

try {
  // ... operation
} catch (error) {
  throw new Error(handleErrors(error));
}
```

**oRPC automatically catches and formats errors** - just throw standard Error objects.

### Environment Configuration

**Environment Variables**
Managed in `apps/backend/src/configs/env.config.ts` using Zod validation.

Key variables:
- `NODE_ENV`: development, production, staging, test
- `DATABASE_URL`: PostgreSQL connection
- `DATABASE_URL_TEST`: Test database connection
- `IS_E2E_TEST`: Flag for E2E test mode
- `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`: OAuth
- `BETTER_AUTH_SECRET`: Auth encryption
- `ALLOWED_ORIGINS`: CORS configuration

**Test Environment**
- Uses separate test database (`DATABASE_URL_TEST`)
- `NODE_ENV=test` automatically set by test scripts
- Test mode disables email requirement for auth

### Database Migrations

**Generate Migration**
```bash
yarn db g <migration_name>
```

Creates migration in `apps/backend/src/db/migrations/`

**Apply Migrations**
```bash
yarn db up           # Main database
NODE_ENV=test yarn db up  # Test database
```

**Seed Data**
```bash
yarn db seed         # Main database
NODE_ENV=test yarn db seed  # Test database
```

Seeds defined in `apps/backend/src/db/seed/`

### Logging

**Pino Logger**
Configured in `apps/backend/src/utils/logger.utils.ts`

```typescript
import { logger } from '../../utils/logger.utils';

logger.info('Operation completed');
logger.error({ err: error }, 'Operation failed');
```

**Log Levels:**
- Production: `info`
- Development: `debug` with pretty printing

### Best Practices

**Code Quality**
- NO `any` or `as unknown` - use strict TypeScript
- Infer types from Zod schemas
- Use direct imports, NO barrel exports
- Prefer `console.info` over `console.log`

**Database**
- Always use descriptive IDs and FKs
- Use transactions for multi-table operations
- Index frequently queried columns
- Use `timestampNumber` for timestamps

**Testing**
- Test all CRUD operations
- Use fixtures for consistent test data
- Clean up test data or use isolated transactions
- Test error cases

**Security**
- Validate all inputs with Zod
- Use `rpcProtectedProcedure` for authenticated endpoints
- Hash sensitive data (API keys with scrypt)
- Sanitize error messages in production

**Error Handling**
- Throw standard Error objects
- Let centralized handler format errors
- Include context in error messages
- Log errors with appropriate level

## Common Patterns

### Create with Author
```typescript
export const createEntry = rpcProtectedProcedure
  .input(entryCreateInputZod)
  .handler(async ({ input, context }) => {
    return db.entries.create({
      ...input,
      authorUserId: context.user.id,
    });
  });
```

### Query with User Filter
```typescript
export const getUserEntries = rpcProtectedProcedure
  .handler(async ({ context }) => {
    return db.entries.where({ authorUserId: context.user.id });
  });
```

### Update with Ownership Check
```typescript
export const updateEntry = rpcProtectedProcedure
  .input(entryUpdateInputZod)
  .handler(async ({ input, context }) => {
    const entry = await db.entries.findBy({ journalEntryId: input.id });
    
    if (entry.authorUserId !== context.user.id) {
      throw new Error('Unauthorized');
    }
    
    return db.entries.find(input.id).update(input);
  });
```

### Transaction Example
```typescript
await db.$transaction(async (tx) => {
  await tx.entries.create(entryData);
  await tx.logs.create(logData);
});
```

## Related Documentation

- [Frontend AGENTS.md](../frontend/AGENTS.md) - React patterns, oRPC client usage
- [Zod Schemas AGENTS.md](../../packages/zod-schemas/AGENTS.md) - Schema patterns
- [Root AGENTS.md](../../AGENTS.md) - Monorepo orchestration
